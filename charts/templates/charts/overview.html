{% extends "charts/base_chart.html" %}{% load i18n static wagtailcore_tags %}

{% block page_title %}{% trans "Dynamics Overview" %}{% endblock %}
{% block title %}{% trans "Dynamics Overview" %}{% endblock %}
{% block breadcrumb_inner %}
{{ block.super }}
<li>{% trans "Dynamics Overview" %}</li>
{% endblock %}

{% comment %}
get the filters that are active with {{ filters }}
the filter formset/widget is in {{ empty_form_conditions }}
or {% include "filters.html" %}, if the downloads are removed from filters.html
{% endcomment %}

{% block before %}
{% endblock %}

{% block description %}
<div class="desc">
    <p class="intention_of_investment" style="display: none">{% trans 'Deals divided by intention of investment.' %}</p>
    <p class="negotiation_status">{%  trans 'Deals divided by negotiation status. Since this chart shows all deals in the database, there is no option to select concluded, intended or failed deals separately.' %}<a href="{% slugurl 'about' %}#how-does-the-global-observatory-deal-with-different-stages-of-negotiation-and-implementation" class="toggle-tooltip left noul" title="{% trans 'The LM has two key variables to describe the status of a land deal: the negotiation status and the implementation status. For further information press the question mark.' %}"><i class="lm lm-question-circle"> </i></a></p>
    <p class="implementation_status" style="display: none">{%trans 'Deals divided by implementation status. Since this chart shows all deals in the database, there is no option to select concluded, intended or failed deals separately.' %} <a href="{% slugurl 'about' %}#how-does-the-global-observatory-deal-with-different-stages-of-negotiation-and-implementation" class="toggle-tooltip left noul" title="{% trans 'The LM has two key variables to describe the status of a land deal: the negotiation status and the implementation status. For further information press the question mark.' %}"><i class="lm lm-question-circle"> </i></a></p>
    <p class="agriculture" style="display: none">{% trans 'Deals having „agriculture“ as main intention of investment disaggregated into sub-sections.' %}</p>

    <input type="checkbox" name="use_deal_size" checked>

</div>
{% endblock %}

{% block legend %}{% endblock %}

{% block data %}
<div class="row">
    <div class="col-md-12">
        <canvas id="bar" width="1200" height="500"></canvas>

    </div>
</div>
{% endblock %}

{% block after %}
{{ block.super }}
<script type="text/javascript" src="{% static "legacy/vendor/RGraph.bar.js" %}"></script>
<script type="text/javascript" src="{% static "legacy/vendor/RGraph.common.core.js" %}"></script>
<script type="text/javascript" src="{% static "legacy/vendor/RGraph.common.effects.js" %}"></script>
<script type="text/javascript" src="{% static "legacy/vendor/RGraph.common.dynamic.js" %}"></script>
<script type="text/javascript" src="{% static "legacy/vendor/RGraph.common.tooltips.js" %}"></script>
<script type="text/javascript">

var datatype = 'size';

$(document).ready(function () {
    $("a.change-variable").click(function (e) {
        e.preventDefault();
        var c_self = this;
        $(".navbar-subnav .active").removeClass("active");
        $(".navbar-subnav a[href='" + $(this).attr("href") + "']").parents("li").addClass("active");
        //($(".navbar-subnav .active a").attr("href").indexOf("intention") > -1 && $(".negotiation_status").show() || $(".negotiation_status").hide());
        $(".desc p").hide().filter("." + $(this).attr("href").replace(/.*\?variable=/, "")).show();
        draw();
        return false;
    });
    $("a.change-variable:first").click();

    var dataSwitch = $("[name='use_deal_size']");
    dataSwitch.bootstrapSwitch({
        onText: 'Size',
        offText: 'Count',
        offColor: 'info',
        onSwitchChange: function(event, state) {
            if (state) {
                datatype = 'size';
            } else {
                datatype = 'count';
            }
            draw();
        }
    });
    $(".views .btn.active").click();
});
var storage = {};

function draw (callback, chart_data) {
/* chart_data: optional */
    RGraph.ObjectRegistry.Clear();
    // Cached data?
    if (chart_data) {
        var bar_labels = [], bar_labels_ingraph = [], bar_data = [];

        var show_deals = (datatype == "count");
        for (var i = 0; i < chart_data.length; i++) {
            if (chart_data[i]["name"] !== "") {
                var label = chart_data[i]["name"];
                if (String(label).indexOf('(') > 0) {
                    label = label.replace('(', '\n(');
                } else if (String(label).length > 15) {
                    label = label.replace(' ', '\n');
                }

                bar_labels.push(label);
                bar_data.push(show_deals && parseInt(chart_data[i]["deals"], 10) || parseInt(chart_data[i]["hectares"], 10));
            }
        }
        for (var i = 0; i < bar_data.length; i++) {
            bar_labels_ingraph.push("<p>" + (show_deals && (bar_data[i] + " deals") || (numberWithCommas(bar_data[i]) +  " ha")) + "</p>");
        }
        var bar = new RGraph.Bar('bar', bar_data);
        bar.Set('chart.hmargin', 40);
        bar.Set('chart.gutter.bottom', 130);
        bar.Set('chart.colors', [show_deals && '#44b7b6' || '#ed881b']);
        bar.Set('chart.labels', bar_labels);
        //bar.Set('chart.labels.above.specific', bar_labels_ingraph);
        bar.Set('chart.strokestyle', '#bbb');
        bar.Set('chart.hmargin.grouped', 0);
        bar.Set('chart.background.barcolor1', '#e2e2e2');
        bar.Set('chart.background.barcolor2', '#ededed');
        bar.Set('chart.background.grid', false);
        bar.Set('chart.background.grid.color', '#d5d5d5');
        bar.Set('chart.text.font', 'Open Sans');
        bar.Set('chart.text.color', '#3b3b3b');
        bar.Set('chart.axis.color', '#3b3b3b');
        bar.Set('chart.text.Angle', 45);
        bar.Set('chart.text.size', '8');
        bar.Set('chart.xlabels.offset', 15);
        bar.Set('chart.tooltips', bar_labels_ingraph);
        bar.Set('chart.tooltips.css.class', 'graph-popover');
        bar.Set('chart.gutter.left', (Math.max.apply(Math, bar_data).toString().length * 11));
        bar.Set('chart.tooltips.event', 'onmousemove');
        RGraph.Effects.Fade.In(bar, {'duration': 250});

        // show/hide data availability
        //var sum = 0;
        //$(chart_data).each(function (i) { sum += chart_data[i].deals; });
        //sum && $(".data-availability").show() || $(".data-availability").hide();
        //// availability pie chart
        //var pie_data = [], pie_labels = [];
        //var available = 0, not_available = 0, not_available_per = 0, //available_per = 0;
        //sum = 0;
        //for (var i = 0; i < chart_data.length; i++) {
        //    sum += chart_data[i][(show_deals && "deals" || "hectares")];
        //    if (chart_data[i]["name"] !== "") {
        //        available += chart_data[i][(show_deals && "deals" || "hectares")]
        //    } else {
        //        not_available += chart_data[i][(show_deals && "deals" || "hectares")];
        //    }
        //}
        //not_available_per = Math.round(not_available/sum*100)
        //available_per = Math.round(available/sum*100)
        //pie_data.push(not_available_per);
        //pie_data.push(available_per);
        //var pie = new RGraph.Pie('pie-availability', pie_data);
        //pie.Set('chart.colors', ['#1e1e1e', '#828282']);
        //pie.Set('chart.radius', 15);
        //pie.Set('chart.strokestyle', '#bbb');
        //pie.Set('chart.text.font', 'Open Sans');
        //pie.Set('chart.text.size', '9');
        //RGraph.Effects.Fade.In(pie, {'duration': 250});
        //$("ul.legend li:first span").text(" (" + numberWithCommas(available) + (//show_deals && " deals" || " hectares") + ", " + available_per + "%)");
        //$("ul.legend li:last span").text(" (" + numberWithCommas(not_available) + (show_deals && " deals" || " hectares") + ", " + not_available_per + "%)");
        (typeof callback == "function") && callback();
    } else {
        var json_query = $(".navbar-subnav li .active a").attr("href").replace(/.*\?variable=/, "") + ".json";
        var query_params = "";
        // rename agriculture
        if (json_query == "agriculture.json") {
            json_query = "intention_of_investment.json";
            query_params += "&intention=agriculture";
        }
        if ((json_query + query_params) in storage) {
            draw(callback, storage[json_query + query_params]);
        } else {
            jQuery.getJSON("/api/" + json_query + query_params, function(data) {
                storage[json_query + query_params] = data;
                draw(callback, data);
            });
        }
    }
};
</script>
{% endblock %}
