{% extends "base.html" %}
{% load i18n custom_tags sass_tags %}
{% load humanize %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static "vendor/openlayers/ol.css" %}"/>
  <link rel="stylesheet" href="{% static "css/nprogress.css" %}"/>
  <link rel="stylesheet" href="{% static "css/ol3-layerswitcher.css" %}"/>
  <link rel="stylesheet" href="{% static "css/map.css" %}"/>
{% endblock %}

{% block page_title %}{% trans "Map" %}{% endblock %}
{% block title %}{% trans "Map" %}{% endblock %}
{% block breadcrumb_inner %}
  <li><a href="{% url 'data' %}">{% trans "Global" %}</a></li>
  <li>{% trans "Map" %}</li>
{% endblock %}

{% block subnav_inner %}
  <li role="presentation" class="active">
    <span><i class="lm lm-map-marker"></i>{% trans "Map" %}</span></li>
  <li role="presentation"><a href="../data/">
    <i class="lm lm-table"></i>{% trans "Data" %}
  </a></li>
  <li role="presentation"><a href="../charts/">
    <i class="lm lm-bar-chart"></i>{% trans "Charts" %}
  </a></li>
  <li class="divider"></li>
  <li role="presentation">
    {% include "export.html" %}
  </li>
{% endblock %}

{% block content %}

  <link rel="stylesheet" href="{% static "map/css/map.css" %}">
  <div class="map-container">
    <div id="map" class="map" title="{% trans "All Deals" %}">
      <img src="{% static "map/images/map-default.png" %}" alt="{% trans "Map with all deals" %}" id="map-placeholder">
    </div>

    <div class="map-progress row">
      <div class="col-md-3">
        <div class="status">
          <div class="glyphicon glyphicon-picture" aria-hidden="true"></div>
          {% trans "Map" %}
        </div>
        <div class="line right"></div>
      </div>
      <div class="col-md-3">
        <div class="line left"></div>
        <div class="status">
          <span class="glyphicon glyphicon-globe" aria-hidden="true"></span>
          {% trans "Countries" %}
        </div>
        <div class="line right"></div>
      </div>
      <div class="col-md-3">
        <div class="line left"></div>
        <div class="status">
          <span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span>
          {% trans "Deals" %}
        </div>
        <div class="line right"></div>
      </div>
      <div class="col-md-3">
        <div class="line left"></div>
        <div class="status">
          <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
          {% trans "Finished" %}
        </div>
      </div>
    </div>

    <div class="map-panel row">
      <div class="col-md-12 tab-container">
        <div class="flex-row">
          <div class="col-md-2 tab-menu flex-col">
            <div class="list-group">
              <a href="#" class="list-group-item active text-center">
                <h4 class="glyphicon glyphicon-cog"></h4><br/>{% trans "Deals" %}
              </a>
              <a href="#" class="list-group-item text-center">
                <h4 class="glyphicon glyphicon-search"></h4><br/>{% trans "Search" %}
              </a>
              <a href="#" class="list-group-item text-center">
                <h4 class="glyphicon glyphicon-filter"></h4><br/>{% trans "Context" %}
              </a>
              <a href="#" class="list-group-item text-center">
                <h4 class="glyphicon glyphicon-unchecked"></h4><br/>{% trans "Base" %}
              </a>
              <a href="#" class="list-group-item text-center show-hide-content">
                <h4 class="glyphicon glyphicon-menu-right"></h4>
              </a>
            </div>
          </div>
          <div class="col-md-10 tab flex-col">
            <div class="tab-content active">
              <h4><span>{% trans "Show info about" %}</span></h4>
              <select class="legend-select">
                <option selected="selected" value="intention">{% trans "Intention of investment" %}</option>
                <option value="accuracy">{% trans "Geospatial Accuracy" %}</option>
                <option value="status">{% trans "Negotiation Status" %}</option>
              </select>
              <h4><span>{% trans "Legend" %}</span></h4>
              <div class="intention legend active">
                <ul>
                  <li>{% trans "Agriculture" %}</li>
                  <li>{% trans "Forestry" %}</li>
                  <li>{% trans "Conservation" %}</li>
                  <li>{% trans "Industry" %}</li>
                  <li>{% trans "Renewable Energy" %}</li>
                  <li>{% trans "Tourism" %}</li>
                  <li>{% trans "Other" %}</li>
                  <li>{% trans "Resource extraction" %}</li>
                  <li>{% trans "Undefined" %}</li>
                </ul>
              </div>
              <div class="accuracy legend">
                <ul>
                  <li>{% trans "better than 100m" %}</li>
                  <li>{% trans "100m to 1km" %}</li>
                  <li>{% trans "1km to 10km" %}</li>
                  <li>{% trans "10km to 100km" %}</li>
                  <li>{% trans "worse than 100km" %}</li>
                </ul>
              </div>
              <div class="status legend">
                <ul>
                  <li>{% trans "Contract canceled" %}</li>
                  <li>{% trans "Negotiations failed" %}</li>
                  <li>{% trans "Contract signed" %}</li>
                  <li>{% trans "Oral agreement" %}</li>
                  <li>{% trans "Expression of interest" %}</li>
                  <li>{% trans "Under negotiation" %}</li>
                </ul>
              </div>
            </div>
            <div class="tab-content">
              <h4><span>{% trans "Search" %}</span></h4>
              <input type="text" placeholder="{% trans "Search location" %}">
              <button>{% trans "Search" %}</button>
            </div>
            <div class="tab-content">
              <h4><span>{% trans "Context" %}</span></h4>
              <ul>
                <li>{% trans "Incidence of poverty" %}</li>
                <li>{% trans "Global Pasture Land" %}</li>
                <li>{% trans "Global Cropland" %}</li>
                <li>{% trans "Global Land Cover 2009" %}</li>
                <li>{% trans "Accessibility" %}</li>
              </ul>
            </div>
            <div class="tab-content">
              <h4><span>{% trans "Base" %}</span></h4>
              <ul>
                <li>{% trans "OpenStreetMap" %}</li>
                <li>{% trans "Satellite" %}</li>
                <li>{% trans "Terrain" %}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script src="https://openlayers.org/en/v4.0.0/build/ol-debug.js" type="text/javascript"></script>
  <script src="{% static "map/js/mapPlugin.js" %}"></script>
  <script>
    $(function () {
      var mapProgress = $(".map-progress");
      var success = "finished";
      var mapPlaceholder = $("#map-placeholder");
      var showIcon = "glyphicon-menu-left";
      var hideIcon = "glyphicon-menu-right";
      var advanceProgressLine = function() {
        var currentProgressLine = mapProgress.find(".line:not(." + success + "):first");
        currentProgressLine.addClass(success);
      };
      var advanceProgress = function() {
        var currentIcon = mapProgress.find(".status:not(." + success + "):first");
        currentIcon.addClass(success);
        advanceProgressLine();
      };

      // first step: replace static image with map.
      advanceProgress();
      var map = $.setMap({
        deals_url: "{% url "deals_api" %}"
      });
      mapPlaceholder.remove();
      advanceProgressLine();

      // load country-data and cluster deals.
      advanceProgress();
      map.loadCountries();

      $("div.tab-menu > div.list-group > a:not(.show-hide-content)").click(function(e) {
        e.preventDefault();
        $(this).siblings("a.active").removeClass("active");
        $(this).addClass("active");
        $("div.tab > div.tab-content").removeClass("active").eq($(this).index()).addClass("active");
      });

      // display legend according to type.
      $(".legend-select").on("change", function() {
         $(".legend").removeClass("active");
         $(".legend." + $(this).val()).addClass("active");
      });

      // show-hide the content box
      $(".show-hide-content").on("click", function() {
          $(".tab").toggleClass("hidden");
          var content = $(this).children("h4:first");
          if(content.hasClass(hideIcon)) {
              content.removeClass(hideIcon).addClass(showIcon);
          } else {
              content.removeClass(showIcon).addClass(hideIcon);
          }
      });
    });

  </script>
{% endblock %}
