{% extends "base.html" %}
{% load i18n custom_tags sass_tags %}
{% load humanize %}
{% load static %}

{% block head %}
  <link rel="stylesheet" href="{% static "vendor/openlayers/ol.css" %}"/>
  <link rel="stylesheet" href="{% static "css/nprogress.css" %}"/>
  <link rel="stylesheet" href="{% static "css/ol3-layerswitcher.css" %}"/>
  <link rel="stylesheet" href="{% static "css/map.css" %}"/>
{% endblock %}

{% block page_title %}{% trans "Map" %}{% endblock %}
{% block title %}{% trans "Map" %}{% endblock %}
{% block breadcrumb_inner %}
  <li><a href="{% url 'data' %}">{% trans "Global" %}</a></li>
  <li>{% trans "Map" %}</li>
{% endblock %}

{% block subnav_inner %}
  <li role="presentation" class="active">
    <span><i class="lm lm-map-marker"></i>{% trans "Map" %}</span></li>
  <li role="presentation"><a href="../data/">
    <i class="lm lm-table"></i>{% trans "Data" %}
  </a></li>
  <li role="presentation"><a href="../charts/">
    <i class="lm lm-bar-chart"></i>{% trans "Charts" %}
  </a></li>
  <li class="divider"></li>
  <li role="presentation">
    {% include "export.html" %}
  </li>
{% endblock %}

{% block content %}

  <link rel="stylesheet" href="{% static "map/css/map.css" %}">
  <div class="map-container">
    <div id="map" class="map">
      <img src="{% static "map/images/map-default.png" %}" alt="{% trans "Map with all deals" %}" id="map-placeholder" style="width: 100%;">
      <div id="popover"></div>
    </div>

    <div class="map-progress row">
      <div class="col-md-3">
        <div class="status">
          <div class="glyphicon glyphicon-picture" aria-hidden="true"></div>
          {% trans "Map" %}
        </div>
        <div class="line right"></div>
      </div>
      <div class="col-md-3">
        <div class="line left"></div>
        <div class="status">
          <span class="glyphicon glyphicon-globe" aria-hidden="true"></span>
          {% trans "Countries" %}
        </div>
        <div class="line right"></div>
      </div>
      <div class="col-md-3">
        <div class="line left"></div>
        <div class="status">
          <span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span>
          {% trans "Deals" %}
        </div>
        <div class="line right"></div>
      </div>
      <div class="col-md-3">
        <div class="line left"></div>
        <div class="status">
          <span class="glyphicon glyphicon-ok" aria-hidden="true"></span>
          {% trans "Finished" %}
        </div>
      </div>
    </div>

    <div class="map-panel row">
      <div class="tab-container">
        <div class="row flex-row">
          <div class="tab flex-col">
            <div class="tab-content active" data-content="deals">
              <h4><span>{% trans "Display" %}</span></h4>
              <div class="row js-layer-switch flex-row well">
                <div class="flex-col" data-show-layer="countries">
                  <svg version="1.1" id="countries" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="70px" height="70px" viewBox="25 25 50 50" enable-background="new 0 0 100 100" xml:space="preserve"><circle class="donut-hole" cx="50" cy="50" r="15.915494309189533" fill="#f9de98"></circle><circle class="donut-ring" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#d2d3d4" stroke-width="7"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#1D6914" stroke-width="7" stroke-dasharray="69.23076923076923 30.769230769230774" stroke-dashoffset="125"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#2A4BD7" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="55.769230769230774"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#814A19" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="55.769230769230774"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#9DAFFF" stroke-width="7" stroke-dasharray="30.76923076923077 69.23076923076923" stroke-dashoffset="55.769230769230774"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#AD2323" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="25"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#575757" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="25"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#81C57A" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="25"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#8126C0" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="25"></circle></svg>
                  <span>{% trans "Group by country" %}</span>
                </div>
                <div class="flex-col disabled" data-show-layer="deals">
                  <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="70px" height="70px" viewBox="25 25 50 50" enable-background="new 0 0 100 100" xml:space="preserve"><circle class="donut-hole" cx="50" cy="50" r="15.915494309189533" fill="#fff"></circle><circle class="donut-ring" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#d2d3d4" stroke-width="7"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#1D6914" stroke-width="7" stroke-dasharray="33.33333333333333 66.66666666666667" stroke-dashoffset="125"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#2A4BD7" stroke-width="7" stroke-dasharray="33.33333333333333 66.66666666666667" stroke-dashoffset="91.66666666666667"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#814A19" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="58.33333333333334"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#9DAFFF" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="58.33333333333334"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#AD2323" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="58.33333333333334"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#575757" stroke-width="7" stroke-dasharray="33.33333333333333 66.66666666666667" stroke-dashoffset="58.33333333333334"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#81C57A" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="25.000000000000014"></circle><circle class="donut-segment" cx="50" cy="50" r="15.915494309189533" fill="transparent" stroke="#8126C0" stroke-width="7" stroke-dasharray="0 100" stroke-dashoffset="25.000000000000014"></circle></svg>
                  <span>{% trans "Individual deals" %}</span>
                </div>
              </div>
              <div class="row">
                <label class="switch switch-auto-cb">
                  <input type="checkbox" checked="checked" class="js-toggle-cluster-auto">
                  <div class="slider round"></div>
                </label>
                {% trans "Autoswitch grouping" %}
              </div>
              <h4><span>{% trans "Show info about" %}</span></h4>
              <select class="legend-select">
                {% for key, data in legend.items %}
                  <option value="{{ key }}"{% if forloop.first %} selected="selected"{% endif %}>{{ data.label }}</option>
                {% endfor %}
              </select>
              <h4><span>{% trans "Legend" %}</span></h4>
              {% for key, data in legend.items %}
                <div class="{{ key }} map-legend{% if forloop.first %} active{% endif %}">
                  <ul>
                    {% for value_element in data.attributes %}
                      <li><span class="legend-symbol" style="background-color:{{ value_element.color }};"></span>{{ value_element.label }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            </div>
            <div class="tab-content" data-content="search">
              <h4><span>{% trans "Search" %}</span></h4>
              <input type="text" placeholder="{% trans "Search location" %}" size="20">
              <br/>
              <button>{% trans "Search" %}</button>
            </div>
            <div class="tab-content" data-content="context">
              <h4><span>{% trans "Context layers" %}</span></h4>
              <ul class="layer-list">
                <li>
                  <input type="checkbox" id="context-layer-land_cover" name="context-layer" value="land_cover">
                  <label for="context-layer-land_cover">{% trans "Land Cover" %}</label>
                  <div class="context-layer-legend"></div>
                </li>
                <li>
                  <input type="checkbox" id="context-layer-cropland" name="context-layer" value="cropland">
                  <label for="context-layer-cropland">{% trans "Global Cropland" %}</label>
                  <div class="context-layer-legend"></div>
                </li>
                <li>
                  <input type="checkbox" id="context-layer-indigenous_lands" name="context-layer" value="indigenous_lands">
                  <label for="context-layer-indigenous_lands">{% trans "Indigenous Lands" %}</label>
                </li>
                <li>
                  <input type="checkbox" id="context-layer-community_lands" name="context-layer" value="community_lands">
                  <label for="context-layer-community_lands">{% trans "Community Lands" %}</label>
                </li>
              </ul>
            </div>
            <div class="tab-content" data-content="base">
              <h4><span>{% trans "Base layers" %}</span></h4>
              <ul class="layer-list">
                <li>
                  <input type="radio" id="base-layer-osm" name="base-layer" value="osm" checked="checked">
                  <label for="base-layer-osm">OSM</label>
                </li>
                <li>
                  <input type="radio" id="base-layer-esri_satellite" name="base-layer" value="esri_satellite">
                  <label for="base-layer-esri_satellite">ESRI Satellite</label>
                </li>
                <li>
                  <input type="radio" id="base-layer-mapquest_satellite" name="base-layer" value="mapquest_satellite">
                  <label for="base-layer-mapquest_satellite">MapQuest Satellite</label>
                </li>
              </ul>
            </div>
            <div class="tab-content" data-content="details">
              <div id="details-overlay">{% trans "Please click on a deal or country on the map to select details." %}</div>
            </div>
          </div>
        <div class="tab-menu flex-col">
          <div class="list-group panel-menu">
            <a href="#" class="list-group-item text-center show-hide-content">
              <h4 class="glyphicon glyphicon-menu-left"></h4>
            </a>
            <a href="#" class="list-group-item text-center active" data-tab="deals">
              <h4 class="glyphicon glyphicon-cog"></h4><br/>{% trans "Deals" %}
            </a>
            <a href="#" class="list-group-item text-center" data-tab="search">
              <h4 class="glyphicon glyphicon-search"></h4><br/>{% trans "Search" %}
            </a>
            <a href="#" class="list-group-item text-center" data-tab="context">
              <h4 class="glyphicon glyphicon-filter"></h4><br/>{% trans "Context" %}
            </a>
            <a href="#" class="list-group-item text-center" data-tab="base">
              <h4 class="glyphicon glyphicon-unchecked"></h4><br/>{% trans "Base" %}
            </a>
            <a href="#" class="list-group-item text-center" data-tab="details">
              <h4 class="glyphicon glyphicon-info-sign"></h4><br/>{% trans "Details" %}
            </a>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block js %}
  <script src="https://openlayers.org/en/v4.0.0/build/ol.js" type="text/javascript"></script>
  <script src="{% static "map/js/mapPlugin.js" %}"></script>
  <script>
    $(function () {
      var mapProgress = $(".map-progress");
      var successClass = "finished";
      var activeClass = "active";
      var mapPlaceholder = $("#map-placeholder");
      var showHideContent = $(".show-hide-content");
      var showIcon = "glyphicon-menu-right";
      var hideIcon = "glyphicon-menu-left";
      var legendSelect = $(".legend-select");
      var mapLegendClass = ".map-legend";
      var tabContainer = $(".tab");
      var menuContainer = $(".panel-menu");
      var layerSwitch = $(".js-layer-switch");

      var advanceProgressLine = function() {
        var currentProgressLine = mapProgress.find(".line:not(." + successClass + "):first");
        currentProgressLine.addClass(successClass);
      };
      var advanceProgress = function() {
        var currentIcon = mapProgress.find(".status:not(." + successClass + "):first");
        currentIcon.addClass(successClass);
        advanceProgressLine();
      };
      var finishProgress = function() {
        mapProgress.find('.line').addClass(successClass);
        advanceProgress();
        mapProgress.fadeOut();
      };

      function showHideTabContent() {
        tabContainer.toggleClass("hidden");
        var content = showHideContent.children("h4:first");
        if(content.hasClass(hideIcon)) {
          content.removeClass(hideIcon).addClass(showIcon);
        } else {
          content.removeClass(showIcon).addClass(hideIcon);
        }
      }

      // show only one tab, and reset 'menu'
      function activateTabContent(element) {
          if (tabContainer.hasClass("hidden")) {
              showHideTabContent();
          }
          // activate selected content-div
          tabContainer.children("div").removeClass(activeClass);
          element.addClass(activeClass);
          // update tab-menu
          menuContainer.children('a').removeClass(activeClass);
          menuContainer.find("a[data-tab='" + element.data('content') + "']").addClass(activeClass);
      }

      // custom input element: switch map layers (grouped or deals)
      function switchLayerTo(element) {
        layerSwitch.children("div").addClass("disabled");
        element.removeClass("disabled");
      }

      /**
       *  Map loading progress
       */

      // first step: replace static image with map.
      advanceProgress();
      var map = $.setMap({
        countriesUrl: "{% url "country_deals_api" %}",
        dealsUrl: "{% url "deals_api" %}",
        legend: {{ legend_json|safe }},
        legendKey: legendSelect.val(),
        featureDetailsElement: "details-overlay",
        featureDetailsUrl: "{% url "map_overlay" %}",
        featureDetailsCallback: activateTabContent,
        visibleLayer: "countries",  // Either "countries" (default) or "deals". Should correspond to state of switch position.
        autoToggle: true,  // Defaults to true. Should correspond to state of checkbox next to switch.
        switchLayerCallback: switchLayerTo
      });
      mapPlaceholder.remove();
      advanceProgressLine();
      // load country-data and cluster deals.
      advanceProgress();
      map.loadCountries();
      // load clustered deals per country.
      map.setDealsPerCountryLayer();
      map.loadDeals();
      advanceProgress();
      map.setDealsLayer();
      advanceProgress();
      finishProgress();

      /**
       *  Handling of panel, tabs, etc.
       */

      // handle tabs for info-panel
      $(".panel-menu a:not(.show-hide-content)").click(function(e) {
        e.preventDefault();
        // load content of clicked tab
        var containerElement = tabContainer.children(
            "div[data-content='" + $(this).data('tab') + "']"
        );
        activateTabContent(containerElement);
      });

      // display legend according to type.
      legendSelect.on("change", function() {
        var selected = $(this).val();
        map.setLegendKey(selected);
        $(mapLegendClass).removeClass(activeClass);
        $(mapLegendClass + "." + selected).addClass(activeClass);
      });

      // show-hide the content box
      showHideContent.on("click", function(e) {
        e.preventDefault();
        showHideTabContent();
      });

      // Toggle to group by countries
      layerSwitch.children("div").on("click", function() {
        switchLayerTo($(this));
        map.toggleVisibleLayer($(this).data("show-layer"));
        // If the toggle is clicked manually, "auto" checkbox is automatically
        // unchecked.
        $('.js-toggle-cluster-auto').prop('checked', false);
      });

      $(".js-toggle-cluster-auto").on("change", function() {
        map.setAutoToggle(this.checked);
      });

      $("input[name='base-layer']").on("change", function() {
        map.toggleBaseLayer(this.value);
      });
      
      $("input[name='context-layer']").on("change", function() {
        map.toggleContextLayer(this);
      });
    });
  </script>
{% endblock %}
