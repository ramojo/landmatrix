{% extends "base.html" %}
{% load i18n custom_tags %}

{% block body_class %}dashboard{% endblock %}

{% block breadcrumb_inner %}
    <li>{% trans "Dashboard" %}</li>
{% endblock %}

{% block page_title %}{% trans "Dashboard" %}{% endblock %}
{% block title %}{% trans "Dashboard" %}{% endblock %}

{% block subnav %}
{% if statistics %}
<ul class="subnav nav nav-pills pull-right">
    <li>
        <span class="label label-default number">{{ statistics.overall_deal_count }}</span> {% trans "Overall deals" %}
    </li>
    <li class="divider"></li>
    <li>
        <span class="label label-default number">{{ statistics.public_deal_count }}</span> {% trans "Public deals" %}
    </li>
    <li class="divider"></li>
    <li>
        <span class="label label-default number">{{ statistics.not_public_deal_count }}</span> {% trans "Non public deals" %}
    </li>
</ul>
{% endif %}
{% endblock %}

{% block content %}
    <div class="dashboard">
        <div class="row">
            <form method="POST" action="{% url 'api_dashboard_filter' %}" id="dashboard-filter">
                {% csrf_token %}
                <div class="controls col-sm-2">
                    <select id="dashboard-filter-region">
                    </select>
                </div>
                <div class="controls col-sm-2">
                    <select id="dashboard-filter-country">
                    </select>
                </div>
                <div class="controls col-sm-2">
                    <select id="dashboard-filter-user">
                    </select>
                </div>
                <div class="controls col-sm-2">
                    <a id="dashboard-filter-clear" class="btn" href="">{% trans 'Clear' %}</a>
                </div>
            </form>
            <script type="text/javascript">
            function initDashboardFilters(data) {
                if (data.length == 0) {
                    return;
                }
                if ('region' in data) {
                    $('#dashboard-filter-region').val(data.region[0]).trigger('change');
                }
                if ('country' in data) {
                    $('#dashboard-filter-country').val(data.country[0]).trigger('change');
                }
                if ('user' in data) {
                    $('#dashboard-filter-user').val(data.user[0]).trigger('change');
                }
                $('#dashboard-filter-region').change(function () {
                    $.post({
                      url: $('form#dashboard-filter').attr('action'),
                      data: {
                        'action': 'set',
                        'region': $(this).val(),
                      },
                      success: function (data) {
                        location.reload();
                      }
                    });
                });
                $('#dashboard-filter-country').change(function () {
                    $.post({
                      url: $('form#dashboard-filter').attr('action'),
                      data: {
                        'action': 'set',
                        'country': $(this).val(),
                      },
                      success: function (data) {
                        location.reload();
                      }
                    });
                });
                $('#dashboard-filter-user').change(function (e) {
                    $.post({
                      url: $('form#dashboard-filter').attr('action'),
                      data: {
                        'action': 'set',
                        'user': $(this).val(),
                      },
                      success: function (data) {
                        location.reload();
                      }
                    });
                });
                $('#dashboard-filter-clear').click(function (e) {
                    e.preventDefault()
                    $.post({
                      url: $('form#dashboard-filter').attr('action'),
                      data: {
                        'action': 'clear',
                      },
                      success: function (data) {
                        location.reload();
                      }
                    });
                });
            }
            $(document).ready(function () {
                // Regions
                var region_select = $('#dashboard-filter-region').select2({
                    placeholder: "{% trans 'Region' %}"
                });
                var region_request = $.ajax({
                  url: '/api/regions.json'
                });
                region_request.then(function (data) {
                  for (var d = 0; d < data.length; d++) {
                    var item = data[d];
                    var option = new Option(item[2], item[0], false, false);
                    region_select.append(option);
                  };
                  //$element.trigger('change');
                });
                // Countries
                var country_select = $('#dashboard-filter-country').select2({
                    placeholder: "{% trans 'Country' %}"
                });
                var country_request = $.ajax({
                  url: '/api/countries.json'
                });
                country_request.then(function (data) {
                  for (var d = 0; d < data.length; d++) {
                    var item = data[d];
                    var option = new Option(item[2], item[0], false, false);
                    country_select.append(option);
                  };
                  //$element.trigger('change');
                });
                // Users
                var user_select = $('#dashboard-filter-user').select2({
                    placeholder: "{% trans 'User' %}"
                });
                var user_request = $.ajax({
                  url: '/api/users.json'
                });
                user_request.then(function (data) {
                  for (var d = 0; d < data.length; d++) {
                    var item = data[d];
                    var option = new Option(item[2], item[0], false, false);
                    user_select.append(option);
                  };
                  //$element.trigger('change');
                });
                // Select current filters
                $.get({
                    url: $('#dashboard-filter').attr('action'),
                    success: function (data)Â {
                        data = JSON.parse(data);
                        initDashboardFilters(data);
                    }
                });

            });
            </script>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-success">
                    <a class="close hidden" data-dismiss="alert">&times;</a>
                    <h3>{% trans "Latest added" %}</h3>
                    {% if latest_added.cs %}
                        <table class="table table-condensed">
                            <thead>
                            <th class="deal">{% trans "Deal #" %}</th>
                            <th class="user">{% trans "Added by" %}</th>
                            <th class="comment">{% trans "Comment" %}</th>
                            <th class="date">{% trans "Added" %}</th>
                            </thead>
                            <tbody>
                            {% for changeset in latest_added.cs %}
                                <tr>
                                    <td class="deal"><a
                                            href="{% url 'deal_detail' deal_id=changeset.deal_id %}">#{{ changeset.deal_id }}</a>
                                    </td>
                                    <td class="user">{{ changeset.user }}</td>
                                    <td class="comment" title="{{ changeset.comment }}"><span
                                            class="truncate">{{ changeset.comment }}</span></td>
                                    {% if changeset.timestamp %}
                                        <td class="date">{{ changeset.timestamp|naturaltime_from_string }}</td>
                                    {% else %}
                                        <td class="date">-</td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% comment %}
      PAGINATION DISABLED AS PER ORALLY AGREED SPEC
    <div class="pagination">
      <ul>
          {% if "previous" in latest_added.pagination %}
              <li><a href="?{% add_or_update_param request.GET 'latest_added_page' latest_added.pagination.previous %}">Previous</a></li>
          {% endif %}
        <li class="active">
              <a href="#">{% trans "Page" %} {{ latest_added.pagination.current }} {% trans "of" %} {{ latest_added.pagination.last }}</a>
        </li>
          {% if "next" in latest_added.pagination %}
              <li><a href="?{% add_or_update_param request.GET 'latest_added_page' latest_added.pagination.next %}" >Next</a></li>
          {% endif %}
      </ul>
    </div>
      {% endcomment %}
                    {% else %}
                        <p>{% trans "No deals have been added lately." %}</p>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <div class="alert alert-warning">
                    <a class="close hidden" data-dismiss="alert">&times;</a>
                    <h3>{% trans "Latest modified" %}</h3>
                    {% if latest_modified.cs %}
                        <table class="table table-condensed">
                            <thead>
                            <th class="deal">{% trans "Deal #" %}</th>
                            <th class="user">{% trans "Modified by" %}</th>
                            <th class="comment">{% trans "Comment" %}</th>
                            <th class="date">{% trans "Modified" %}</th>
                            </thead>
                            <tbody>
                            {% for changeset in latest_modified.cs %}
                                <tr>
                                    <td class="deal"><a
                                            href="{% url 'deal_detail' deal_id=changeset.deal_id %}">#{{ changeset.deal_id }}</a>
                                    </td>
                                    <td class="user">{{ changeset.user }}</td>
                                    <td class="comment" title="{{ changeset.comment }}"><span
                                            class="truncate">{{ changeset.comment }}</span></td>
                                    {% if changeset.timestamp %}
                                        <td class="date">{{ changeset.timestamp|naturaltime_from_string }}</td>
                                    {% else %}
                                        <td class="date">-</td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% comment %}
      PAGINATION DISABLED AS PER ORALLY AGREED SPEC
    <div class="pagination">
      <ul>
          {% if "previous" in latest_modified.pagination %}
              <li><a href="?{% add_or_update_param request.GET 'latest_modified_page' latest_modified.pagination.previous %}">Previous</a></li>
          {% endif %}
          <li class="active">
              <a href="#">{% trans "Page" %} {{ latest_modified.pagination.current }} {% trans "of" %} {{ latest_modified.pagination.last }}</a>
          </li>
          {% if "next" in latest_modified.pagination %}
              <li><a href="?{% add_or_update_param request.GET 'latest_modified_page' latest_modified.pagination.next %}">Next</a></li>
          {% endif %}
      </ul>
    </div>
      {% endcomment %}
                    {% else %}
                        <p>{% trans "No deals have been modified lately." %}</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="alert alert-danger">
                    <a class="close hidden" data-dismiss="alert">&times;</a>
                    <h3>{% trans "Latest deleted" %}</h3>
                    {% if latest_deleted.cs %}
                        <table class="table table-condensed">
                            <thead>
                            <th class="deal">{% trans "Deal #" %}</th>
                            <th class="user">{% trans "Deleted by" %}</th>
                            <th class="comment">{% trans "Comment" %}</th>
                            <th class="date">{% trans "Deleted" %}</th>
                            </thead>
                            <tbody>
                            {% for changeset in latest_deleted.cs %}
                                <tr>
                                    <td class="deal"><a
                                            href="{% url 'deal_detail' deal_id=changeset.deal_id %}">#{{ changeset.deal_id }}</a>
                                    </td>
                                    <td class="user">{{ changeset.user }}</td>
                                    <td class="comment" title="{{ changeset.comment }}"><span
                                            class="truncate">{{ changeset.comment }}</span></td>
                                    {% if changeset.timestamp %}
                                        <td class="date">{{ changeset.timestamp|naturaltime_from_string }}</td>
                                    {% else %}
                                        <td class="date">-</td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        {% comment %}
      PAGINATION DISABLED AS PER ORALLY AGREED SPEC
    <div class="pagination">
      <ul>
          {% if "previous" in latest_deleted.pagination %}
              <li><a href="?{% add_or_update_param request.GET 'latest_deleted_page' latest_deleted.pagination.previous %}">Previous</a></li>
          {% endif %}

          <li class="active">
              <a href="#">{% trans "Page" %} {{ latest_deleted.pagination.current }} {% trans "of" %} {{ latest_deleted.pagination.last }}</a>
          </li>

          {% if "next" in latest_deleted.pagination %}
              <li><a href="?{% add_or_update_param request.GET 'latest_deleted_page' latest_deleted.pagination.next %}">Next</a></li>
          {% endif %}
      </ul>
    </div>
      {% endcomment %}
                    {% else %}
                        <p>{% trans "No deals have been deleted lately." %}</p>
                    {% endif %}
                </div>
            </div>

        {% if perms.editor.change_activity %}
                <div class="col-md-6">
                    <div class="alert alert-info">
                        <a class="close hidden" data-dismiss="alert">&times;</a>
                        <h3>{% trans "Needs your attention" %}</h3>
                        {% if manage.a_changesets or manage.sh_changesets %}
                            <table class="table table-condensed">
                                <thead>
                                <th class="deal">{% trans "Deal #" %}</th>
                                <th class="user">{% trans "Last revision" %}</th>
                                <th class="state">{% trans "State" %}</th>
                                <th class="action">{% trans "Actions" %}</th>
                                </thead>
                                <tbody>
                                {% for changeset in manage.a_changesets.updates.cs %}
                                    <tr class="update">
                                        <td class="deal"><a
                                                href="{% url 'deal_detail' deal_id=changeset.deal_id %}">#{{ changeset.deal_id }}</a>
                                        </td>
                                        <td class="user">{{ changeset.user }}</td>
                                        <td class="state">{% trans "Update" %}</td>
                                        <td class="action">
                                            <a href="{% url 'manage_deal' type='deal' action='approve' id=changeset.id %}"
                                               class="approve">{% trans "Approve" %}</a>
                                            <a href="{% url 'manage_deal' type='deal' action='reject' id=changeset.id %}"
                                               class="reject">{% trans "Reject" %}</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                {% for changeset in manage.a_changesets.deletes.cs %}
                                    <tr class="delete">
                                        <td class="deal"><a
                                                href="{% url 'deal_detail' deal_id=changeset.deal_id %}">#{{ changeset.deal_id }}</a>
                                        </td>
                                        <td class="user">{{ changeset.user }}</td>
                                        <td class="state">{% trans "Delete" %}</td>
                                        <td class="action">
                                            <a href="{% url 'manage_deal' type='deal' action='approve' id=changeset.id %}"
                                               class="approve">{% trans "Approve" %}</a>
                                            <a href="{% url 'manage_deal' type='deal' action='reject' id=changeset.id %}"
                                               class="reject">{% trans "Reject" %}</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                {% for changeset in manage.a_changesets.inserts.cs %}
                                    <tr class="insert">
                                        <td class="deal"><a
                                                href="{% url 'deal_detail' deal_id=changeset.deal_id %}">#{{ changeset.deal_id }}</a>
                                        </td>
                                        <td class="user">{{ changeset.user }}</td>
                                        <td class="state">{% trans "Add" %}</td>
                                        <td class="action">
                                            <a href="{% url 'manage_deal' type='deal' action='approve' id=changeset.id %}"
                                               class="approve">{% trans "Approve" %}</a>
                                            <a href="{% url 'manage_deal' type='deal' action='reject' id=changeset.id %}"
                                               class="reject">{% trans "Reject" %}</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                {% for changeset in manage.sh_changesets.deletes.cs %}
                                    <tr class="deletes">
                                        <td class="investor"><a
                                                href="{% url 'stakeholder_form' investor_id=changeset.investor_id %}">#{{ changeset.investor_id }}</a>
                                        </td>
                                        <td class="user">{{ changeset.user }}</td>
                                        <td class="state">{% trans "Delete" %}</td>
                                        <td class="action">
                                            <a href="{% url 'manage_deal' type='deal' action='approve' id=changeset.id %}"
                                               class="approve">{% trans "Approve" %}</a>
                                            <a href="{% url 'manage_deal' type='deal' action='reject' id=changeset.id %}"
                                               class="reject">{% trans "Reject" %}</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <a href="{% url 'manage' %}">{% trans "Show all" %}</a>
                        {% else %}
                            <p>{% trans "No pending changesets require your attention." %}</p>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <div class="col-md-6">
                <div class="alert alert-info">
                    <a class="close hidden" data-dismiss="alert">&times;</a>
                    <h3>{% trans "Feedback requests" %}</h3>
                    {% if feedbacks.feeds %}
                        <table class="table table-condensed">
                            <thead>
                            <th class="deal">{% trans "Deal #" %}</th>
                            <th class="user">{% trans "Request from" %}</th>
                            <th class="comment">{% trans "Comment" %}</th>
                            <th class="date">{% trans "Requested" %}</th>
                            </thead>
                            <tbody>
                            {% for feedback in feedbacks.feeds %}
                                <tr>
                                    <td class="deal"><a
                                            href="{% url 'deal_detail' deal_id=feedback.deal_id %}">#{{ feedback.deal_id }}</a></td>
                                    <td class="user">{{ feedback.from_user }}</td>
                                    <td class="comment" title="{{ feedback.comment }}"><span
                                            class="truncate">{{ feedback.comment }}</span></td>
                                    <td class="date">{{ feedback.timestamp|naturaltime_from_string }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        <a href="{% url 'manage' %}">{% trans "Show all" %}</a>
                    {% else %}
                        <p>{% trans "No feedback requests lately." %}</p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>

{% endblock %}
