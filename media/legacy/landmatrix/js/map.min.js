m=Raphael("map",960,svgheight,function(){function u(e,d,a,c,g){b.setViewBox(d-c/2,a-g/2,c,g);l.css("display","block");b.clearBubbles();e.region_id&&jQuery.ajax({url:URL_PREFIX+"api/target_country_summaries.json?regions="+e.region_id,dataType:"json"}).done(function(a){b.drawBubbles(a)});n();$("#map").addClass("zoomed").data("zoom-coords",{x:d,y:a,width:c,height:g});$(".title.map h2").text(e.region)}function n(){p.fadeOut();q.fadeOut();r.css("visibility","visible")}function v(e,d){function a(a){x=(a+
"").split(".");x1=x[0];x2=1<x.length?"."+x[1]:"";for(a=/(\d+)(\d{3})/;a.test(x1);)x1=x1.replace(a,"$1,$2");return x1+x2}$("#map-overlay .investment-sectors a").each(function(){var a=$(this),c=a.attr("class"),c=c.charAt(c.indexOf("sector-")+7).toUpperCase();!a.data("initial_title")&&a.data("initial_title",a.data("title"));a.data("title",a.data("initial_title")+"<br/>(no data available)");if(null!=d.investment_sectors&&-1!=d.investment_sectors.indexOf(c)){var b=URL_PREFIX+"get-the-detail/"+(d.country_id?
"by-target-country/"+d.country_slug:"by-target-region/"+d.region_slug);a.removeClass("none").attr("href",b+"?investment_natures="+c)}else a.addClass("none")});g=URL_PREFIX+"api/investment_sector_deals_for_"+(d.country_id?"target_country.json?country="+d.country_id:"target_region.json?region="+d.region);jQuery.ajax({url:g,dataType:"json"}).done(function(a){var c=$("#map-overlay .investment-sectors a");jQuery.each(a,function(a,b){if(b.investment_sector){var d=c.filter(".sector-"+b.investment_sector.toLowerCase());
d.data("title",d.data("initial_title")+"<br/>("+b.deals+" "+(1==b.deals?"deal":"deals")+")")}})});$("#map-overlay .pie-chart").data("title","Data availability: "+d.availability+"%").html("<span>"+Math.round(d.availability)+"%</span>");var c=$("#map-overlay .title h2 a").text(d.country||d.name);if(d.country_id){var g=URL_PREFIX+"get-the-detail/by-target-country/"+d.country_slug;c.unbind("click").attr("href",g);s.attr("href",g).css("display","block");t.hide();o.hide()}else d.region_id&&(g=function(a){var c=
b.getXY(d.lon,d.lat);u(d,c.cx,c.cy,320,187);w.attr("href",URL_PREFIX+"get-the-detail/by-target-country?regions="+d.region_id);a.preventDefault()},o.unbind("click").click(g),c.attr("href","").unbind("click").click(g),s.hide(),t.attr("href",URL_PREFIX+"get-the-detail/by-target-region/"+d.region_slug).css("display","block"));c=a(d.deals)+" deal";1!=d.deals&&(c+="s");d.hectares&&(c+=" over "+a(d.hectares)+" ha");$("#map-overlay .title h3").html(c);q.fadeIn(function(){drawPie($("#map-overlay .pie-chart")[0],
40,!0);p.fadeIn()});r.css("visibility","hidden")}var b=this;b.regionBubbles=[];b.countryBubbles=[];b.importSVG(vectors);b.setFinish();b.getXY=function(b,d){var a=(1.07*b+150)*(this.width/360),c=Math.abs(1.03*d-90+10)*(this.height/180);return{cx:a,cy:c}};var f,l=$("#map-zoom-out"),o=$("#map-zoom-in"),y=$("#clear-map-overlay"),q=$("#overlay-container"),p=$("#map-overlay"),s=$("#get-details-link"),t=$("#table-link"),r=$("#container").children("ul.subnav"),w=$("#subnav-table-link");$(".subnav .country-table");
f=$("#map").hasClass("investor-target")?$("#map").hasClass("target")?"target":"investor":"";b.bubbles=[];b.drawLine=function(e,d){var a=e.getBBox(),c=d.getBBox(),a=b.path("M"+(a.x+a.width/2)+" "+(a.y+a.height/2)+"L"+(c.x+c.width/2)+" "+(c.y+c.height/2)).attr({stroke:"target"==f?"#da8a1c":"#58b1bf","stroke-width":2});e.lines.push(a)};b.clearBubbles=function(e){jQuery.each(b.bubbles,function(b,a){a.lines&&jQuery.each(a.lines,function(a,b){b.remove()});a!==e&&(a.caption&&a.caption.remove(),a.remove())});
b.bubbles=[];e&&b.bubbles.push(e)};b.showInfobox=function(b,d){var a=$(".current-country"),c=b.country||b.name,g;"investor"==b.type?a.find("h3").text("By "+c):a.find("h3").text("In "+c);"investor"==b.type&&a.addClass("investor")||a.removeClass("investor");d?parseInt(d.country_id)==parseInt(b.country_id)?(c="deal",a.find(".related-country").hide(),a.find(".self-deals").html("whereof<br/> "+(b.deals-(d.self_deals+d.unknown_deals))+" transnatnl.<br />"+d.self_deals+" domestic<br/>"+d.unknown_deals+" unknown").show()):
("investor"==f?(c="deal",g="by"):(c="deal",g="in"),a.find(".related-country").text(g+" "+(d.name||d.country)).show(),a.find(".self-deals").hide()):(c="deal",a.find(".related-country").hide(),a.find(".self-deals").hide());a.find(".total-deals").text(b.deals+" "+c+(1==b.deals?"":"s"));c=URL_PREFIX+"get-the-detail/";c="investor"==b.type?c+"by-investor-country/"+b.country_slug+"?mode=table":c+b.region_slug+"/"+b.country_slug+"?mode=table";a.find("a").attr("href",c);a.show()};b.onInvestorTargetBubbleClick=
function(e,d,a){return function(c){$(".actions .show-all:not(:visible)").fadeIn();a&&(f="investor"==f?"target":"investor");e.attr({fill:"target"==f?"#da8a1c":"#58b1bf"});b.clearBubbles(e);url="target"==f?URL_PREFIX+"api/investor_countries_for_target_country.json":URL_PREFIX+"api/target_countries_for_investor_country.json";url=url+"?country="+d.country_id;jQuery.ajax({url:url,dataType:"json"}).done(function(a){b.drawRelatedBubbles(a,[e,d]);a=$("ul.actions li.select").removeClass("investor target").addClass(f);
a.find("a.current").text(a.find("li."+f).text());a.find("li").removeClass("current").filter("."+f).addClass("current");$("#map").removeClass("investor"==f?"target":"investor").addClass(f)});c.preventDefault()}};b.drawBubbles=function(e){jQuery.each(e,function(d,a){if(a.country_id&&!f){var c=4;0<a.deals&&(c+=Math.log(a.deals))}else c=8,0<a.deals&&(c+=3*Math.log(a.deals)+a.deals/100);var e=b.getXY(a.lon,a.lat),h=b.circle().attr({fill:f?"target"==f?"#da8a1c":"#58b1bf":"#da8a1c",href:"#",stroke:"#fff",
"stroke-width":2,r:1}).data("title",f?a.country:a.name).attr(e);f&&(a.type=f);h.animate({r:c},1E3,"bounce",f&&function(){h.animate({r:8},1E3,"backIn");h.caption.hide()});e=b.text().attr({text:a.deals,fill:"#ffffff",href:"#",y:e.cy,x:e.cx});e.attr({"font-size":a.country_id&&!f?4:12});jQuery.each([h,e],function(d,e){e.event_click=f?b.onInvestorTargetBubbleClick(h,a,!1):function(b){v($(this.id),a);b.preventDefault()};e.click(e.event_click);e.block=!1;e.event_mouseenter=function(d){e.block||(e.block=
!0,h.toFront().stop().animate({r:1.5*c},1E3,"bounce",function(){e.block=!1}).caption.toFront(),f&&h.caption.show()&&b.showInfobox(a),!f&&showTooltip(h,d))};e.event_mouseleave=function(a){h.stop().animate({r:f?8:c},1E3,"bounce",function(){e.block=!1});f&&h.caption.hide();!f&&hideTooltip(h,a)};e.hover(e.event_mouseenter,e.event_mouseleave)});h.caption=e;h.lines=[];b.bubbles.push(h)})};b.drawRelatedBubbles=function(e,d){var a=d[0],c=d[1];c.known_deals=0;c.unknown_deals=0;c.self_deals=0;jQuery.each(e,
function(e,d){if(d.country_id==c.country_id)return c.self_deals=parseInt(d.deals),!0;d.name?c.known_deals+=parseInt(d.deals):c.unknown_deals+=parseInt(d.deals);var k=8;0<d.deals&&(k+=3*Math.log(d.deals)+d.deals/100);var j=b.getXY(d.lon,d.lat),i=b.circle().attr({fill:"target"==f?"#58b1bf":"#da8a1c",href:"#",stroke:"#fff","stroke-width":2,r:1}).attr(j).data("title",d.name).data("radius",k);f&&(d.type="investor"==f?"target":"investor");b.drawLine(a,i);j=b.text().attr({text:d.deals,fill:"#fff",href:"#",
y:j.cy,x:j.cx});j.attr({"font-size":12}).hide();jQuery.each([i,j],function(a,e){e.event_click=b.onInvestorTargetBubbleClick(i,d,!0);e.click(e.event_click);e.event_mouseenter=function(){i.animate({r:1.5*k},1E3,"bounce");b.showInfobox(d,c)};e.event_mouseleave=function(){i.animate({r:k},1E3,"bounce")};e.hover(e.event_mouseenter,e.event_mouseleave)});i.caption=j;i.lines=[];b.bubbles.push(i)});b.showBubbles=function(){jQuery.each(b.bubbles,function(b,c){if(c==a)return!0;c.animate({r:c.data("radius")},
1E3,"bounce").toFront();c.caption.show().toFront()})};setTimeout("map.showBubbles()",300);jQuery.each([a,a.caption],function(a,d){d.unhover(d.event_mouseenter).unclick(d.event_click).hover(function(){b.showInfobox(c,c)},function(){})});a.animate({r:8},1E3,"backIn");a.caption.hide();c.deals=c.known_deals+c.self_deals+c.unknown_deals};f?jQuery.ajax({url:"investor"==f?URL_PREFIX+"api/investor_country_summaries.json":URL_PREFIX+"api/target_country_summaries.json",dataType:"json"}).done(function(e){b.drawBubbles(e);
b.countryBubbles=e}):jQuery.ajax({url:URL_PREFIX+"api/target_region_summaries.json",dataType:"json"}).done(function(e){b.drawBubbles(e);b.regionBubbles=e});l.click(function(e){l.hide();n();o.show();b.setViewBox(0,0,960,ssvgheight);b.clearBubbles();b.drawBubbles(b.regionBubbles);$("#map").removeClass("zoomed").data("zoom-coords",null);e.preventDefault()});$(".actions .show-all").click(function(e){b.clearBubbles();b.drawBubbles(b.countryBubbles);$(".current-country").hide();$(this).fadeOut();e.preventDefault();
return!1});y.click(function(b){n();b.preventDefault()});window.map=b});
