{% extends "global_base.html" %}
{% load i18n custom_tags wagtailcore_tags %}
{% load humanize %}

{% block page_title %}{% if group == "all" %}{% trans "All deals" %}{% elif filters.group_value %}{{ name }}{% else %}
    {% trans "By" %} {{ group }}{% endif %}{% endblock %}
{% block title %}{% if group == "all" %}{% trans "All deals" %}{% elif filters.group_value %}{{ name }}{% else %}
    {% trans "By" %} {{ group }}{% endif %}{% endblock %}

{% block breadcrumb %}
    <ul class="breadcrumb">
        <li><a href="/">{% trans 'Home' %}</a></li>
        <li><a href="{% url 'data' %}">{% trans 'Global' %}</a></li>
        {% if group == "all" %}
            <li>{% trans "All deals" %}</li>
        {% elif filters.group_value %}
            <li><a href="{% url 'table_list' group=group_slug %}/?{% add_or_update_param request.GET 'order_by' '' %}">{% trans "By" %} {{ group }}</a>
            </li>
            <li>{{ name }}</li>
        {% else %}
            <li>{% trans "By" %} {{ group }}</li>
        {% endif %}
    </ul>
{% endblock %}

{% block subnav_inner %}
    <li role="presentation"><a href="{% url 'map' %}">
        <i class="lm lm-map-marker"></i>{% trans "Map" %}
    </a></li>
    <li role="presentation" class="active"><span>
        <i class="lm lm-table"></i>{% trans "Data" %}
    </span></li>
    <li role="presentation"><a href="{% url 'charts' %}">
        <i class="lm lm-bar-chart"></i>{% trans "Charts" %}
    </a></li>
    <li class="divider"></li>
    <li role="presentation">
        {% include "export.html" %}
    </li>
{% endblock %}

{% block content %}
    {% include "grid/subnav.html" %}
    {% include "filters.html" %}

    {% if data.items %}
        <div class="summary-wrap">
            <table id="summary" class="table table-striped">
                <thead>
                  <tr>
                    {% for column in columns %}
                        <th class="number">
                            <a class="{{ column.name }}{% if data.order_by == column.name %} asc{% elif data.order_by == '-'|add:column.name %} desc{% endif %}" href="?{% add_or_update_param request.GET 'order_by' column.order_by %}">
                              {{ column.label }}
                            </a>
                        </th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                {% for item in data.items %}
                    <tr class="{% if forloop.counter|divisibleby:2 %}even{% else %}odd{% endif %}">
                        {% for column, value in item.items %}
                            {% if column == "deal_id" %}
                                <td class="{{ column }} deal-id">
                                    <a href="{% if request.user.is_staff %}{% url 'change_deal' item.deal_id %}{% else %}{% url 'deal_detail' item.deal_id %}{% endif %}" class="label label-default">{{ item.deal_id }}</a>
                                </td>
                            {% elif column == "crop" %}
                                <td class="{{ column }}" style="width:341px">
                                    {% if  item.crop %}
                                        {% for c in item.crop %}
                                            <a href="{% url 'data' variable='crop' operator='is' value=c|slugify %}">{{ c }}</a>
                                            </br>
                                        {% endfor %}
                                        {% else %}{% trans "Unknown" %}
                                    {% endif %}
                                </td>
                            {% elif column == "intention" %}
                                <td class="{{ column }}">
                                    <ul class="list-unstyled">
                                        {% if item.intention %}
                                            {% for i in item.intention %}
                                                <li>
                                                    <a href="{% url 'data' %}?variable=intention&operator=is&value={{ i }}"
                                                       {% if group != "intention" %}class="intention-icon {{ i|slugify }}"
                                                       data-content="{{ i }}"{% endif %}><span>{{ i }}</span></a>
                                                </li>
                                            {% endfor %}
                                            {% else %}{% trans "Unknown" %}
                                        {% endif %}
                                    </ul>
                                </td>
                            {% elif column == "operational_stakeholder" %}
                                <td class="{{ column }}" style="width:183px">
                                    {% if item.operational_stakeholder %}
                                        {% for i in item.operational_stakeholder %}
                                            {{ i }}<br/>
                                        {% endfor %}
                                        {% else %}{% trans "Unknown" %}
                                    {% endif %}
                                </td>
                            {% elif "investor_country" == column %}
                                <td class="{{ column }} investor-country">
                                    {% if item.investor_country %}
                                        {% for investor_country  in item.investor_country %}
                                            <a href="{% url 'data' %}?variable=investor_country&operator=is&value={{ investor_country|slugify }}">{{ investor_country }}</a>
                                            <br/>
                                        {% endfor %}
                                    {% else %}{% trans "Unknown country" %}{% endif %}
                                </td>
                            {% elif "investor_region" == column %}
                                <td class="{{ column }} investor-region">
                                    {% if item.investor_region %}
                                        {% for investor_region  in item.investor_region %}
                                            <a href="{% url 'data' %}?variable=investor_region&operator=is&value={{ investor_region|slugify }}">{{ investor_region }}</a>
                                            <br/>
                                        {% endfor %}
                                    {% else %}{% trans "Unknown region" %}{% endif %}
                                </td>
                            {% elif column == "target_country" %}
                                <td class="{{ column }}">
                                    {% if item.target_country %}
                                        {% for target_country  in item.target_country %}
                                            <a href="{% url 'data' %}?variable=target_country&operator=is&value={{ target_country|slugify }}">{{ target_country }}</a>
                                            <br/>
                                        {% endfor %}
                                    {% else %}
                                        {% trans "Unknown" %}
                                    {% endif %}
                                </td>
                            {% elif column == "target_region" %}
                                <td class="{{ column }}">
                                    {% if item.target_region %}
                                        {% for target_region  in item.target_region %}
                                            <a href="{% url 'data' %}?variable=target_region&operator=is&value={{ target_region|slugify }}">{{ target_region }}</a>
                                            <br/>
                                        {% endfor %}
                                    {% else %}
                                        {% trans "Unknown" %}
                                    {% endif %}
                                </td>
                            {% elif column == "year" %}
                                <td class="{{ column }}">
                                    {% if item.year %}
                                        <a href="{% url 'data' %}?variable=year&operator=is&value={{ item.year }}">{{ item.year }}</a>
                                        <br/>
                                    {% else %}
                                        {% trans "Unknown" %}
                                    {% endif %}
                                </td>
                            {% elif column == "data_source_type" %}
                                <td class="{{ column }}">
                                    {% if item.data_source_type %}
                                        {% for data_source_type in item.data_source_type %}
                                            <a href="{% url 'data' %}?variable=data_source_type&operator=is&value={{ data_source_type }}">{{ data_source_type }}</a>
                                            <br/>
                                        {% endfor %}
                                    {% else %}
                                        {% trans "Unknown" %}
                                    {% endif %}
                                </td>
                            {% elif column == "deal_size" %}
                                <td class="{{ column }} number">{{ item.deal_size|intcomma }}</td>
                            {% elif column == "intended_size" %}
                                <td class="{{ column }} number">
                                    {% if item.intended_size %}{{ item.intended_size|intcomma }}{% else %}
                                        {% trans "Unknown" %}{% endif %}</td>
                            {% elif column == "contract_size" %}
                                <td class="{{ column }} number">
                                    {% if item.contract_size %}{{ item.contract_size|intcomma }}{% else %}
                                        {% trans "Unknown" %}{% endif %}</td>
                            {% elif column == "deal_count" %}
                                <td class="{{ column }} deals number">{{ item.deal_count }}</td>
                            {% elif column == "availability" %}
                                <td>{{ item.availability }}%</td>
                            {% elif column == "implementation_status" %}
                                <td class="{{ column }}">
                                    {% if item.implementation_status %}
                                        {% with item.implementation_status|last as implementation_stati %}
                                            {% if implementation_stati.year != 0 %}
                                                [{{ implementation_stati.year }}]
                                            {% endif %}
                                            {{ implementation_stati.name }}
                                        {% endwith %}
                                    {% else %}
                                        {% trans "Unknown" %}
                                    {% endif %}
                                </td>
                            {% elif column == "negotiation_status" %}
                                <td class="{{ column }}">
                                    {% if item.negotiation_status %}
                                        {% with item.negotiation_status|last as negotiation_stati %}
                                            {% if negotiation_stati.year != 0 %}
                                                [{{ negotiation_stati.year }}]
                                            {% endif %}
                                            {{ negotiation_stati.name }}
                                        {% endwith %}
                                    {% else %}
                                        {% trans "Unknown" %}
                                    {% endif %}
                                </td>
                            {% else %}
                            <td class="{{ column }}">
                                {{ value|join:', ' }}
                            </td>
                            {% endif %}
                        {% endfor %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
        {% if load_more %}
            <a href="?{% add_or_update_param request.GET 'more' load_more %}" class="btn pull-left">{% trans "Show more" %}</a>
        {% endif %}
        <p class="pull-right"><span class="label label-default">{{ data.count|intcomma }}</span> {% trans "deals" %}</p>
    {% else %}
        <p>{% trans "There are currently no deals matching your search criteria." %} <a
                href="{% url 'add_deal' %}">{% trans "Add a deal" %}</a>.</p>
    {% endif %}
{% endblock %}
